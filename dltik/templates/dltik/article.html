{% extends "dltik/base.html" %}

{% block title %}{{ article.title }}{% endblock %}
{% block description %}{{ article.summary }}{% endblock %}

{% block og_title %}{{ article.title }}{% endblock %}
{% block og_description %}{{ article.summary }}{% endblock %}
{% if article.cover_image %}
    {% block og_image %}{{ article.cover_image }}{% endblock %}
{% endif %}

{% block twitter_title %}{{ article.title }}{% endblock %}
{% block twitter_description %}{{ article.summary }}{% endblock %}

{% block content %}
<div class="container py-5">
    <article class="bg-white rounded shadow-sm p-4">
        <header class="mb-4">
            <h1 class="fw-bold">
                {{ article.title }}
            </h1>
            <p class="text-muted fst-italic mb-3">
                <i class="bi bi-calendar3 me-1"></i> {{ article.published_at|date:"d/m/Y" }}
                {% if article.author %}
                    <span class="ms-2"><i class="bi bi-person-fill me-1"></i>{{ article.author.get_full_name|default:article.author.username }}</span>
                {% endif %}
            </p>
        </header>
        {% if article.show_toc %}
            <div id="toc" class="mb-4 p-3 border rounded bg-light position-relative">
              <button id="toggle-toc" class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 m-2" type="button">
                <i class="bi bi-chevron-up"></i>
              </button>
              <strong class="mb-2 d-block text-primary">Mục lục bài viết</strong>
              <ul id="toc-list" class="list-unstyled ps-3 mb-0"></ul>
            </div>

        {% endif %}

        <div class="article-body mb-4">
            {{ article.content|safe }}
        </div>

        {% if article.get_tags %}
            <footer class="pt-3 border-top">
                <strong><i class="bi bi-tags me-1"></i>Từ khóa:</strong>
                {% for tag in article.get_tags %}
                    <a href="{% url 'tagged_articles' tag=tag %}" class="badge bg-secondary me-1 text-decoration-none">
                      <i class="bi bi-tag-fill me-1"></i>{{ tag }}
                    </a>
                {% endfor %}
            </footer>
        {% endif %}
    </article>
</div>
{% endblock %}
{% block extra_scripts %}
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const content = document.querySelector(".article-body");
        const tocList = document.getElementById("toc-list");
        const toggleBtn = document.getElementById("toggle-toc");
        const toc = document.getElementById("toc");

        if (!content || !tocList || !toggleBtn) return;

        // Tạo TOC
        const headings = content.querySelectorAll("h2, h3, h4, h5");
        let counter = 1;
        headings.forEach(heading => {
          const tagName = heading.tagName.toLowerCase();
          const id = heading.id || `section-${counter++}`;
          heading.id = id;

          const li = document.createElement("li");
          li.className = tagName === "h3" ? "ms-3" : "";

          const a = document.createElement("a");
          a.href = `#${id}`;
            a.addEventListener("click", function (e) {
              e.preventDefault();
            
              location.hash = id;

              setTimeout(() => {
                const target = document.getElementById(id);
                if (target) {
                  target.classList.add("highlight-heading");
                  setTimeout(() => {
                    target.classList.remove("highlight-heading");
                  }, 600);
                }
              }, 10);
            });


          a.textContent = heading.textContent;
          a.className = "text-decoration-none";

          li.appendChild(a);
          tocList.appendChild(li);
        });

        // Nút thu gọn/mở rộng
        toggleBtn.addEventListener("click", () => {
          tocList.classList.toggle("d-none");
          const icon = toggleBtn.querySelector("i");
          icon.classList.toggle("bi-chevron-up");
          icon.classList.toggle("bi-chevron-down");
        });
      });
    </script>
    <style>
      .highlight-heading {
        animation: highlightZoom 0.6s ease-in-out;
      }

      @keyframes highlightZoom {
        0% {
          transform: scale(1);
          background-color: transparent;
        }
        25% {
          transform: scale(1.05);
          background-color: #fff3cd; /* màu vàng nhạt */
        }
        100% {
          transform: scale(1);
          background-color: transparent;
        }
      }
    </style>

{% endblock %}
